#!/usr/bin/env python3

import logging
import argparse

import pyglet
from pyglet.window.key import KeyStateHandler
from pyglet import gl

# parse arguments
parser = argparse.ArgumentParser()
parser.add_argument('--loglevel', action='store', default='warn')
parser.add_argument('--logfile', action='store', default='')
args = parser.parse_args()

# setup root logger
logger = logging.getLogger()
if args.logfile:
    handler = logging.FileHandler(args.logfile)
else:
    handler = logging.StreamHandler()
logger.addHandler(handler)
handler.setFormatter(logging.Formatter(
    '%(asctime)s %(levelname)s %(name)s %(message)s'))
try:
    a = getattr(logging, args.loglevel.upper())
except AttributeError:
    raise ValueError('Invalid log level: {!s}'.format(args.loglevel))
else:
    logger.setLevel(a)

logger.info("Initializing game...")

# Now that logger is up, import stuff
from gensokyo import locator
from gensokyo import clock
from gensokyo import event
from gensokyo.scene import SceneStack
from gensokyo.scene import main_menu
from gensokyo.globals import WIDTH, HEIGHT, FPS
from gensokyo import resources

# broadcast
logger.debug("Initializing broadcast...")
broadcast = event.Broadcast()
locator.broadcast = broadcast

# window
logger.debug("Initializing window...")
window = pyglet.window.Window(WIDTH, HEIGHT)
broadcast.open('window', window)
locator.window = window

window.set_caption('TouhouS')
window.set_icon(resources.icon16, resources.icon32)

# Transparency
logger.debug("Setting transparency...")
gl.glEnable(gl.GL_BLEND)
gl.glBlendFunc(gl.GL_SRC_ALPHA, gl.GL_ONE_MINUS_SRC_ALPHA)

# Scene stack
logger.debug("Creating scene stack...")
scene_stack = SceneStack()
locator.scene_stack = scene_stack

# key_state
logger.debug("Creating KeyState...")
keys = KeyStateHandler()
window.push_handlers(keys)
locator.key_state = keys

# clock
logger.debug("Initializing clock...")
pyglet.clock.set_fps_limit(FPS)
clock = clock.Clock()
broadcast.open('clock', clock)

logger.debug("Pushing menu onto stack...")
locator.scene_stack.push(main_menu.MenuScene())

logger.info("Finished init.")
logger.info("Running...")
pyglet.app.run()
